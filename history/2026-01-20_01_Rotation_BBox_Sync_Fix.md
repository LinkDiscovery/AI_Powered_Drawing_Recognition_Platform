# BBox 회전 동기화 및 좌표 정렬 수정 내역

**날짜:** 2026-01-20
**작업자:** AI Assistant (Antigravity)

## 1. 문제 상황 (Problem)
*   **증상:** 사용자가 이미지를 회전시킨 상태에서 BBox(영역 박스)를 그리고 저장하면, 나중에 다시 파일을 열거나 회전시킬 때 박스 위치가 엉뚱한 곳으로 이동함.
*   **원인:**
    1.  **회전 상태 미저장:** 사용자가 설정한 이미지 회전 각도(`rotation`)가 서버에 저장되지 않아, 다시 열면 항상 0도(원본)로 초기화됨.
    2.  **좌표계 불일치:** 박스 좌표가 "현재 눈에 보이는 회전된 화면" 기준으로 저장됨. 이를 나중에 다른 각도나 원본 상태에서 불러오면 좌표 기준이 달라져 위치가 어긋남.

## 2. 해결 방법 (Solution)

### A. 데이터베이스 및 백엔드 (DB & Backend)
*   **파일:** `UserFile.java`, `FileController.java`
*   **내용:**
    *   `user_files` 테이블에 `rotation` 컬럼 추가.
    *   파일 저장/수정 시 회전 각도도 함께 DB에 저장하고, 불러올 때 이를 반환하도록 수정.
    *   기존 데이터 호환성을 위해 `psql`을 통해 기존 레코드의 `rotation` 값을 `0`으로 초기화.

### B. 프론트엔드 - 뷰어 로직 (Frontend - Viewer)
*   **파일:** `PdfViewer.tsx`
*   **핵심 로직 변경 (Coordinate Standardization):**
    *   **저장 원칙:** 모든 박스 데이터는 **"원본(0도) 이미지"** 기준으로 변환하여 관리 및 저장.
    *   **표시 원칙:** 화면에 그릴 때(`render`)는 현재 회전 각도(90도, 180도 등)에 맞춰 좌표를 실시간으로 변환(`transformRect`)하여 표시.
    *   **변환 함수 구현:**
        *   `toView`: 원본 좌표 -> 현재 회전 화면 좌표 (표시용)
        *   `toZero`: 현재 회전 화면 좌표 -> 원본 좌표 (저장용)
    *   이 과정에서 가로/세로(`width`/`height`)가 뒤바뀌는 차원(Dimension) 스왑 로직을 적용하여 정확도 확보.

### C. 프론트엔드 - 연동 (Integration)
*   **파일:** `UserDashboard.tsx`, `PreviewPage.tsx`, `FileContext.tsx`
*   **내용:**
    *   대시보드에서 파일 클릭 시 DB에 저장된 `rotation` 값을 가져와 뷰어 초기값으로 전달.
    *   저장 버튼 클릭 시 현재 `rotation` 값을 함께 전송.

### D. 추가 개선 - 서버 측 이미지 영구 회전 (Server-Side Physical Rotation)
*   **요청 사항:** 모델 학습 시 전처리 없이 바로 사용할 수 있도록, 저장 시 이미지 파일 자체를 회전시켜달라는 요청.
*   **구현 내용 (`FileController.java`):**
    *   사용자가 저장(`Save`) 버튼을 누를 때, `rotation` 값이 0이 아니면 동작.
    *   **이미지 처리:** Java의 `ImageIO`를 사용해 서버에 저장된 원본 파일을 읽어서 실제로 회전시킨 후 덮어쓰기(Overwrite).
    *   **좌표 변환:** 기존 BBox 좌표(0도 기준)를 회전된 이미지 기준(새로운 0도)으로 자동 변환하여 저장.
    *   **메타데이터 초기화:** 파일이 실제로 회전되었으므로, DB의 `rotation` 값은 다시 `0`으로 초기화.
    *   **결과:** 사용자가 90도 돌려서 저장하면, 파일 탐색기에서 파일을 열어도 90도 돌아가 있으며, BBox도 정확한 위치에 유지됨.

## 3. 결과 (Result)
*   **화면 동기화:** 회전 상태에서도 박스 좌표가 정확히 일치.
*   **데이터 활용성:** 저장된 이미지와 좌표 데이터를 그대로 모델 학습(Training)에 투입 가능 (별도 전처리 불필요).

---
*Generated by Antigravity*
