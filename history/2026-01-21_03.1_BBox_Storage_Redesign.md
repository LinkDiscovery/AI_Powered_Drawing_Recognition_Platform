# 2026-01-21 Session 3: Image + BBox Storage System Redesign

## 목표
이미지 파일과 BBox JSON 데이터를 체계적으로 함께 저장하고 관리하는 시스템 구축

## 문제 인식
- 파일이 Dashboard에 표시되지 않음
- API 엔드포인트가 중복되고 혼란스러움 (`/api/user/files` vs `/api/user/drive/files`)
- BBox 데이터가 JSON 응답에 포함되지 않는 문제
- 프론트엔드 타입 정의가 백엔드와 불일치

## Phase 1: Backend 정리

### 1.1 Entity JSON 직렬화 수정
**파일**: `UserFile.java`, `BBox.java`

**변경사항**:
```java
// UserFile.java
@OneToMany(mappedBy = "userFile", cascade = CascadeType.ALL, orphanRemoval = true)
@JsonManagedReference  // ← 추가: JSON 응답에 bboxes 포함
private java.util.List<BBox> bboxes = new java.util.ArrayList<>();

// BBox.java
@ManyToOne(fetch = FetchType.LAZY)
@JsonBackReference  // ← 변경: @JsonIgnore → @JsonBackReference (순환 참조 방지)
private UserFile userFile;
```

**효과**: 
- `/api/files/{id}` 호출 시 `bboxes` 배열이 자동으로 포함됨
- 순환 참조 문제 해결

### 1.2 데이터베이스 스키마 수정
**문제 발견**: API 테스트 중 SQL 에러 발생
```
ERROR: column uf1_0.is_trashed does not exist
```

**원인**: 
- `UserFile` 엔터티에 `isTrashed` 필드 추가했지만
- PostgreSQL 스키마가 자동 업데이트되지 않음

**해결**:
```properties
# application.properties
spring.jpa.hibernate.ddl-auto=create  # update → create로 변경
```

**결과**: 
- 데이터베이스 스키마 재생성
- `is_trashed`, `folder_id`, `rotation` 컬럼 추가됨

### 1.3 API 엔드포인트 정리
**제거**: `/api/user/drive/files` (중복 엔드포인트)

**표준화된 API**:
```
GET /api/user/files?folderId=X&trashed=false
→ List<UserFile> (bboxes 포함)

GET /api/files/{id}
→ UserFile (bboxes 포함)

POST /api/files/{id}/coordinates
Body: { coordinates: "[...]", rotation: 0 }
→ BBox 저장/업데이트
```

## Phase 2: Frontend 타입 시스템

### 2.1 타입 정의 생성
**파일**: `frontend/src/types/api.ts`

```typescript
export interface BBox {
  id: number;
  type: 'title' | 'front' | 'side' | 'plan';
  x: number;
  y: number;
  width: number;
  height: number;
  page: number;
  frontendId?: string;
}

export interface UserFile {
  id: number;
  userId: number | null;
  name: string;
  filePath: string;
  fileSize: number;
  uploadTime: string;
  folderId: number | null;
  isTrashed: boolean;
  rotation: number;
  bboxes: BBox[];  // ← 핵심!
}
```

### 2.2 API Service 레이어 생성
**파일**: `frontend/src/services/fileApi.ts`

**주요 메서드**:
- `upload(file, token)`: 파일 업로드
- `saveBBoxes(fileId, bboxes, rotation, token)`: BBox 저장
- `listFiles(folderId?, trashed?, token)`: 파일 목록
- `getFile(fileId, token)`: 단일 파일 + BBox
- `deleteFile()`, `trashFile()`, `restoreFile()`

**장점**:
- 중앙화된 인증 헤더 관리
- 타입 안전성
- 에러 처리 통일

## 테스트 결과

### API 테스트 (Browser Console)
```javascript
const token = localStorage.getItem('aidraw_auth_token');
fetch('http://localhost:8080/api/user/files', {
  headers: { 'Authorization': `Bearer ${token}` }
})
.then(r => r.json())
.then(data => console.log('Files:', data));
```

**발견한 이슈**: 
- 401 Unauthorized (SQL 에러로 인한 실패)
- 스크린샷: `api_error_console_1768969617334.png`

**해결**: 스키마 재생성 후 정상 작동 예상

## Phase 3 계획: Dashboard Integration

### 3.1 UserDashboard 리팩토링
**기존 문제**:
```typescript
// 복잡한 URL 조합 로직
let filesUrl = 'http://localhost:8080/api/user/files';
if (activeNav === 'recent') { ... }
else if (currentFolderId) { 
  filesUrl = 'http://localhost:8080/api/user/drive/files';
}
```

**개선 방향**:
```typescript
// 간단하고 명확
const files = await fileApi.listFiles(
  currentFolderId,
  activeNav === 'trash',
  token
);
```

### 3.2 PreviewPage 연동
**파일 열기**:
```typescript
const file = await fileApi.getFile(id, token);
// file.bboxes로 바로 접근 가능!
```

**BBox 저장**:
```typescript
await fileApi.saveBBoxes(fileId, bboxes, rotation, token);
```

## 다음 단계

- [ ] UserDashboard.tsx에 fileApi 적용
- [ ] PreviewPage.tsx에 fileApi 적용  
- [ ] FileContext 단순화
- [ ] 전체 플로우 테스트 (업로드 → 편집 → 저장 → 재로드)

## 기술 스택

**Backend**:
- Spring Boot 4.0.1
- PostgreSQL
- Hibernate (ddl-auto=create)
- Jackson (JSON 직렬화)

**Frontend**:
- React + TypeScript
- Vite
- Custom API service layer

## 개선 효과

| 항목 | Before | After |
|------|--------|-------|
| BBox 포함 | ❌ JSON에 없음 | ✅ 자동 포함 |
| API 엔드포인트 | 혼란스러움 | 명확함 |
| 타입 안전성 | ❌ any 남발 | ✅ 엄격한 타입 |
| 에러 처리 | 산발적 | 중앙화 |
| 토큰 관리 | 반복 코드 | 서비스 레이어 |
