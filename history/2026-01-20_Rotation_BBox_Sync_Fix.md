# BBox 회전 동기화 및 좌표 정렬 수정 내역

**날짜:** 2026-01-20
**작업자:** AI Assistant (Antigravity)

## 1. 문제 상황 (Problem)
*   **증상:** 사용자가 이미지를 회전시킨 상태에서 BBox(영역 박스)를 그리고 저장하면, 나중에 다시 파일을 열거나 회전시킬 때 박스 위치가 엉뚱한 곳으로 이동함.
*   **원인:**
    1.  **회전 상태 미저장:** 사용자가 설정한 이미지 회전 각도(`rotation`)가 서버에 저장되지 않아, 다시 열면 항상 0도(원본)로 초기화됨.
    2.  **좌표계 불일치:** 박스 좌표가 "현재 눈에 보이는 회전된 화면" 기준으로 저장됨. 이를 나중에 다른 각도나 원본 상태에서 불러오면 좌표 기준이 달라져 위치가 어긋남.

## 2. 해결 방법 (Solution)

### A. 데이터베이스 및 백엔드 (DB & Backend)
*   **파일:** `UserFile.java`, `FileController.java`
*   **내용:**
    *   `user_files` 테이블에 `rotation` 컬럼 추가.
    *   파일 저장/수정 시 회전 각도도 함께 DB에 저장하고, 불러올 때 이를 반환하도록 수정.
    *   기존 데이터 호환성을 위해 `psql`을 통해 기존 레코드의 `rotation` 값을 `0`으로 초기화.

### B. 프론트엔드 - 뷰어 로직 (Frontend - Viewer)
*   **파일:** `PdfViewer.tsx`
*   **핵심 로직 변경 (Coordinate Standardization):**
    *   **저장 원칙:** 모든 박스 데이터는 **"원본(0도) 이미지"** 기준으로 변환하여 관리 및 저장.
    *   **표시 원칙:** 화면에 그릴 때(`render`)는 현재 회전 각도(90도, 180도 등)에 맞춰 좌표를 실시간으로 변환(`transformRect`)하여 표시.
    *   **변환 함수 구현:**
        *   `toView`: 원본 좌표 -> 현재 회전 화면 좌표 (표시용)
        *   `toZero`: 현재 회전 화면 좌표 -> 원본 좌표 (저장용)
    *   이 과정에서 가로/세로(`width`/`height`)가 뒤바뀌는 차원(Dimension) 스왑 로직을 적용하여 정확도 확보.

### C. 프론트엔드 - 연동 (Integration)
*   **파일:** `UserDashboard.tsx`, `PreviewPage.tsx`, `FileContext.tsx`
*   **내용:**
    *   대시보드에서 파일 클릭 시 DB에 저장된 `rotation` 값을 가져와 뷰어 초기값으로 전달.
    *   저장 버튼 클릭 시 현재 `rotation` 값을 함께 전송.

## 3. 결과 (Result)
*   사용자가 이미지를 회전하고 박스를 그려도, 해당 위치가 이미지의 특정 피쳐(Feature)에 정확히 고정됨.
*   재접속 시에도 마지막으로 작업한 회전 각도와 박스 위치가 그대로 복원됨.

---
*Generated by Antigravity*
