# 2026-01-27 OCR 결과 자동 표시 및 중복 방지 기능 구현

## 작업 일시
2026년 1월 27일

## 작업 개요
이미 OCR 처리가 완료된 파일을 선택했을 때 기존 결과를 자동으로 표시하는 기능과, OCR 결과가 중복으로 저장되는 문제를 해결했습니다.

---

## 1. OCR 결과 자동 표시 기능

### 문제점
- 이미 OCR 처리된 파일을 다시 선택해도 기존 결과를 볼 수 없었음
- 매번 "OCR 인식 시작" 버튼을 눌러야 했음
- 불필요한 재처리 발생

### 해결 방안
파일 선택 시 자동으로 기존 OCR 결과를 조회하여 표시하는 기능 구현

### Frontend 변경사항

#### [AiRecognitionPage.tsx](file:///d:/AI_Powered_Drawing_Recognition_Platform/frontend/src/pages/ai-recognition/AiRecognitionPage.tsx)

**1. 타입 확장**
```typescript
interface TitleBlockResult {
    id: number;
    extractedText: string;
    projectName: string;
    drawingName: string;
    drawingNumber: string;
    scale: string;
    processedAt?: string; // 추가
}
```

**2. 상태 관리**
```typescript
const [hasExistingOcr, setHasExistingOcr] = useState(false);
```

**3. OCR 결과 조회 함수**
```typescript
const fetchExistingOcrResult = async (fileId: number) => {
    if (!token) return;

    try {
        const response = await fetch(`/api/ocr/results/${fileId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const results: TitleBlockResult[] = await response.json();
            if (results && results.length > 0) {
                const latest = results[results.length - 1];
                setOcrResult(latest);
                setHasExistingOcr(true);
                setShowResultForm(true);
                return;
            }
        }
    } catch (err) {
        console.error('Failed to fetch OCR results:', err);
    }

    setHasExistingOcr(false);
    setOcrResult(null);
    setShowResultForm(false);
};
```

**4. 파일 선택 시 자동 조회**
```typescript
const handleFileSelect = async (file: FileItem) => {
    // ... 파일 로드 로직 ...
    
    // 3. 기존 OCR 결과 조회 (새로 추가)
    await fetchExistingOcrResult(file.id);
};
```

**5. UI 개선**

- **OCR 상태 배지**: 파일명 옆에 녹색 배지 표시
  ```tsx
  {hasExistingOcr && ocrResult && (
      <span style={{ backgroundColor: '#10B981', color: 'white' }}>
          ✓ OCR 처리 완료 ({날짜})
      </span>
  )}
  ```

- **조건부 버튼 텍스트**
  ```tsx
  {hasExistingOcr ? '다시 인식하기' : 'OCR 인식 시작'}
  ```

- **처리 시간 표시**
  ```tsx
  {ocrResult.processedAt && (
      <span>처리 시간: {new Date(ocrResult.processedAt).toLocaleString('ko-KR')}</span>
  )}
  ```

### 사용자 경험 개선

**Before:**
1. 파일 선택
2. "OCR 인식 시작" 버튼 클릭
3. 처리 대기
4. 결과 확인

**After:**
1. 파일 선택
2. ✓ 기존 결과 자동 표시 (OCR 완료된 경우)
3. 필요시 "다시 인식하기" 클릭

---

## 2. OCR 중복 데이터 문제 해결

### 문제점
- `OcrController.processOcr()` 메서드가 항상 새로운 레코드를 생성
- 같은 파일에 대해 OCR을 여러 번 실행하면 중복 데이터가 계속 누적
- DB 용량 낭비 및 데이터 일관성 문제

### 해결 방안
Update-or-Create 패턴 구현 (기존 레코드가 있으면 업데이트, 없으면 생성)

### Backend 변경사항

#### [OcrController.java](file:///d:/AI_Powered_Drawing_Recognition_Platform/backend/platform-backend/src/main/java/com/example/demo/OcrController.java)

**1. Import 추가**
```java
import java.time.LocalDateTime;
```

**2. Update-or-Create 로직 구현**
```java
@PostMapping("/process/{fileId}")
public ResponseEntity<?> processOcr(@PathVariable Long fileId, @RequestBody BBox bbox,
        @RequestHeader("Authorization") String token) {
    // ... 검증 로직 ...
    
    try {
        // OCR 수행
        String extractedText = ocrService.performOcr(filePath, bbox);

        // 기존 OCR 결과 조회
        Optional<TitleBlockText> existingOpt = titleBlockTextRepository
            .findTopByUserFileIdOrderByProcessedAtDesc(fileId);

        TitleBlockText titleBlockText;
        if (existingOpt.isPresent()) {
            // 기존 레코드 업데이트
            titleBlockText = existingOpt.get();
            titleBlockText.setExtractedText(extractedText);
            
            // 파싱된 필드 업데이트
            TitleBlockText parsed = ocrService.parseText(extractedText, userFile);
            titleBlockText.setProjectName(parsed.getProjectName());
            titleBlockText.setDrawingName(parsed.getDrawingName());
            titleBlockText.setDrawingNumber(parsed.getDrawingNumber());
            titleBlockText.setScale(parsed.getScale());
            titleBlockText.setProcessedAt(LocalDateTime.now());
        } else {
            // 새 레코드 생성
            titleBlockText = ocrService.parseText(extractedText, userFile);
        }

        TitleBlockText saved = titleBlockTextRepository.save(titleBlockText);
        return ResponseEntity.ok(saved);
    } catch (Exception e) {
        // ... 에러 처리 ...
    }
}
```

### 데이터베이스 정리 도구

#### [cleanup_ocr_duplicates.sql](file:///d:/AI_Powered_Drawing_Recognition_Platform/backend/cleanup_ocr_duplicates.sql)
PostgreSQL용 중복 데이터 정리 스크립트 (5단계 프로세스)

#### [check_duplicates.sql](file:///d:/AI_Powered_Drawing_Recognition_Platform/backend/check_duplicates.sql)
빠른 중복 확인 및 통계 스크립트

#### [OCR_CLEANUP_GUIDE.md](file:///d:/AI_Powered_Drawing_Recognition_Platform/backend/OCR_CLEANUP_GUIDE.md)
PostgreSQL 환경에서의 중복 정리 가이드

### 동작 방식

**Before (수정 전):**
```
파일 100에 대해 OCR 3번 실행:
ID  user_file_id  project_name  processed_at
1   100          "프로젝트A"    2026-01-27 09:00
2   100          "프로젝트A"    2026-01-27 09:05  ← 중복
3   100          "프로젝트A"    2026-01-27 09:10  ← 중복
```

**After (수정 후):**
```
파일 100에 대해 OCR 3번 실행:
ID  user_file_id  project_name  processed_at
1   100          "프로젝트A"    2026-01-27 09:10  ← 업데이트됨

- 첫 실행: 새 레코드 생성 (ID: 1)
- 두 번째 실행: ID 1 업데이트, processed_at 갱신
- 세 번째 실행: ID 1 업데이트, processed_at 갱신
```

---

## 변경된 파일 목록

### Frontend
- `frontend/src/pages/ai-recognition/AiRecognitionPage.tsx`
  - OCR 결과 자동 조회 기능 추가
  - UI 상태 표시 개선
  - 조건부 버튼 텍스트

### Backend
- `backend/platform-backend/src/main/java/com/example/demo/OcrController.java`
  - Update-or-Create 패턴 구현
  - 타임스탬프 자동 갱신

### 새로 추가된 파일
- `backend/cleanup_ocr_duplicates.sql` - PostgreSQL 중복 정리 스크립트
- `backend/check_duplicates.sql` - 중복 확인 스크립트
- `backend/OCR_CLEANUP_GUIDE.md` - 정리 가이드

---

## 테스트 시나리오

### 1. OCR 결과 자동 표시
1. ✅ 새 파일 업로드 → OCR 처리 → 결과 저장
2. ✅ 파일 다시 선택 → 기존 결과 자동 표시
3. ✅ "다시 인식하기" 버튼으로 재처리 가능
4. ✅ 처리 시간 표시 확인

### 2. 중복 방지
1. ✅ 같은 파일에 대해 OCR 여러 번 실행
2. ✅ DB에서 레코드 1개만 유지 확인
3. ✅ `processed_at` 타임스탬프 갱신 확인

---

## 기대 효과

### 사용자 경험
- ✅ 즉시 결과 확인 가능
- ✅ 불필요한 재처리 방지
- ✅ 명확한 상태 표시

### 데이터 관리
- ✅ DB 용량 절약 (파일당 1개 레코드)
- ✅ 데이터 일관성 보장
- ✅ 조회 성능 향상

### 유지보수
- ✅ 명확한 데이터 구조
- ✅ 디버깅 용이
- ✅ 확장 가능한 구조

---

## 다음 단계 (선택사항)

1. **기존 중복 데이터 정리**
   - pgAdmin 또는 psql에서 `cleanup_ocr_duplicates.sql` 실행
   - 또는 그대로 두고 새로운 중복만 방지

2. **OCR 결과 편집 기능**
   - PUT API 추가하여 결과 수정 가능하게 개선

3. **OCR 이력 관리**
   - 여러 번 처리된 경우 이력 추적
   - 이전 버전과 비교 기능

---

## 참고 문서
- [Implementation Plan](file:///C:/Users/asus/.gemini/antigravity/brain/c4580456-71f8-4cf0-a92f-abfc148e1fd4/implementation_plan.md)
- [Walkthrough](file:///C:/Users/asus/.gemini/antigravity/brain/c4580456-71f8-4cf0-a92f-abfc148e1fd4/walkthrough.md)
- [OCR Cleanup Guide](file:///d:/AI_Powered_Drawing_Recognition_Platform/backend/OCR_CLEANUP_GUIDE.md)
